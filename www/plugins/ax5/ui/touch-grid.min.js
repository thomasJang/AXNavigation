!function(root,ax_super){var U=ax5.util,axd=ax5.dom,ax_class=function(){this.main=function(){ax_super&&ax_super.call(this),this.config={click_event_name:"ontouchstart"in document.documentElement?"touchstart":"click",theme:"default",head_height:28,item_height:28,col_min_width:30,body:{}}}.apply(this,arguments),this.target=null,this.focused_index=-1,this.col_group=[],this.col_width_sum=0,this.list=[],this.virtual_scroll={};var cfg=this.config;this.init=function(){cfg.target||U.error("aui_touch_grid_400","[ax5.ui.touch_grid] config.target is required"),this.target=ax5.dom(cfg.target),this.col_group=this._convert_col_group(cfg.col_group),this.target.html(this._get_frame()),this.els={root:this.target.find('[data-touch-grid-els="root"]'),main:this.target.find('[data-touch-grid-els="main"]'),"main-header":this.target.find('[data-touch-grid-els="main-header"]'),"main-body":this.target.find('[data-touch-grid-els="main-body"]'),"main-body-content":this.target.find('[data-touch-grid-els="main-body-content"]')},cfg.control&&(this.els.control=this.target.find('[data-touch-grid-els="control"]'),this.els.control.on("click",function(e){this._oncontrol(e||window.event)}.bind(this))),this._set_size_frame(),this.els["main-header"].html(this._get_header("main-header")),this.els["main-body-content"].html(this._get_body("main-body")),this.els["main-body-content-tbody"]=this.els["main-body-content"].find('[data-touch-grid-els="main-body-content-tbody"]'),this.bind_window_resize(function(){this.col_group=this._convert_col_group(cfg.col_group),this._set_size_frame(),this._set_size_col_group()})},this._get_frame=function(){var po=[];return po.push('<div class="ax5-ui-touch-grid '+cfg.theme+'" data-touch-grid-els="root">'),po.push('<div class="touch-grid-body" data-touch-grid-els="body">'),po.push('<div class="touch-grid-main" data-touch-grid-els="main">'),po.push('<div class="touch-grid-main-header" data-touch-grid-els="main-header">'),po.push("</div>"),po.push('<div class="touch-grid-main-body" data-touch-grid-els="main-body">'),po.push('<div class="touch-grid-content" data-touch-grid-els="main-body-content"></div>'),po.push("</div>"),po.push("</div>"),po.push("</div>"),cfg.control&&(po.push('<div class="touch-grid-control" data-touch-grid-els="control" style="width:'+cfg.control.width+'px;">'),po.push('<table cellpadding="0" cellspacing="0" style="height:100%;">'),po.push("<tbody>"),cfg.control.first&&(po.push("<tr>"),po.push("<td>"),po.push('<div class="ax-item-wraper"><button class="ax-btn '+(cfg.control.klass||"")+'" data-touch-grid-control="first">'+cfg.control.first+"</buttton></div>"),po.push("</td>"),po.push("</tr>")),cfg.control.prev&&(po.push("<tr>"),po.push("<td>"),po.push('<div class="ax-item-wraper"><button class="ax-btn '+(cfg.control.klass||"")+'" data-touch-grid-control="prev">'+cfg.control.prev+"</buttton></div>"),po.push("</td>"),po.push("</tr>")),cfg.control.next&&(po.push("<tr>"),po.push("<td>"),po.push('<div class="ax-item-wraper"><button class="ax-btn '+(cfg.control.klass||"")+'" data-touch-grid-control="next">'+cfg.control.next+"</button></div>"),po.push("</td>"),po.push("</tr>")),cfg.control.last&&(po.push("<tr>"),po.push("<td>"),po.push('<div class="ax-item-wraper"><button class="ax-btn '+(cfg.control.klass||"")+'" data-touch-grid-control="last">'+cfg.control.last+"</buttton></div>"),po.push("</td>"),po.push("</tr>")),po.push("</tbody>"),po.push("</table>"),po.push("</div>")),po.push("</div>"),po.join("")},this._set_size_frame=function(){var target_height=this.target.height();if(this.els.main.css({height:target_height}),this.els["main-header"].css({height:cfg.head_height}),this.els["main-body"].css({height:target_height-cfg.head_height}),cfg.control){this.els.control.css({height:target_height});var control_item=this.els.control.find(".ax-item-wraper");control_item.css({height:target_height/control_item.elements.length})}this.virtual_scroll.size=Math.ceil((target_height-cfg.head_height)/cfg.item_height)},this._convert_col_group=function(col_group){var CG=[],target_width=this.target.width(),free_width=target_width,free_width_col_count=0;cfg.control&&(free_width-=cfg.control.width);for(var i=0,l=col_group.length;l>i;i++)CG.push(U.clone(col_group[i]));this.col_width_sum=0;for(var i=0,l=CG.length;l>i;i++)U.is_undefined(CG[i].width)||"*"===CG[i].width?free_width_col_count++:(this.col_width_sum+=U.number(CG[i].width),free_width-=U.number(CG[i].width));if(free_width_col_count>0)for(var i=0,l=CG.length;l>i;i++)(U.is_undefined(CG[i].width)||"*"===CG[i].width)&&(CG[i].width=free_width/free_width_col_count,CG[i].width<cfg.col_min_width&&(CG[i].width=cfg.col_min_width),this.col_width_sum+=U.number(CG[i].width));return cfg.control&&(this.col_width_sum-=cfg.control.width),CG},this._get_col_group=function(){var po=[];po.push("<colgroup>");for(var i=0,l=this.col_group.length;l>i;i++)po.push('<col data-touch-grid-col="'+i+'"  style="width:'+this.col_group[i].width+'px;" />');return po.push("</colgroup>"),po.join("")},this._set_size_col_group=function(){for(var i=0,l=this.col_group.length;l>i;i++)this.els.main.find('[data-touch-grid-col="'+i+'"]').css({width:this.col_group[i].width});this.els.main.find("[data-touch-grid-table]").css({width:this.col_width_sum})},this._get_header=function(typ){var po=[];po.push('<table data-touch-grid-table="'+typ+'" style="width:'+this.col_width_sum+"px;height:"+cfg.head_height+"px;line-height:"+cfg.head_height+'px;">'),po.push(this._get_col_group()),po.push("<tbody>"),po.push('<tr style="'+function(){return cfg.head_align?"text-align:"+cfg.head_align+";":""}()+'">');for(var i=0,l=this.col_group.length;l>i;i++)po.push('<td style="'+function(C){return cfg.head_align||!C.align?"":"text-align:"+C.align+";"}(this.col_group[i])+'">'+this.col_group[i].label+"</td>");return po.push("</tr>"),po.push("</tbody>"),po.push("</table>"),po.join("")},this._get_body=function(typ){var po=[];return po.push('<table data-touch-grid-table="'+typ+'" style="width:'+this.col_width_sum+'px;">'),po.push(this._get_col_group()),po.push('<tbody data-touch-grid-els="main-body-content-tbody"></tbody>'),po.push("</table>"),po.join("")},this._get_list=function(){for(var item,po=[],end_index=this.virtual_scroll.end_index,r=this.virtual_scroll.start_index,len=end_index>this.list.length?this.list.length:end_index;len>r;r++){item=this.list[r],po.push('<tr data-touch-grid-item-row="'+r+'" style="height:'+cfg.item_height+'px;">');for(var i=0,l=this.col_group.length;l>i;i++)po.push('<td style="'+function(C){return C.align?"text-align:"+C.align+";":""}(this.col_group[i])+'">'+this._get_col_value(item,this.col_group,r,i)+"</td>");po.push("</tr>")}return po.join("")},this._get_col_value=function(item,CG,r,ci){if(U.is_function(CG[ci].formatter)){var that={index:r,list:this.list,item:item,col_group:CG,key:CG[ci].key,col_index:ci,value:item[CG[ci].key]};return CG[ci].formatter.call(that)||""}return"money"===CG[ci].formatter?U.number(item[CG[ci].key]||0,{money:!0}):item[CG[ci].key]||""},this._content_scroll=function(top){"undefined"==typeof top?top=U.number(this.els["main-body-content"].position().top,{abs:!0}):this.els["main-body-content"].css({top:-top}),this.virtual_scroll.start_index=Math.floor(top/cfg.item_height),this.virtual_scroll.end_index=U.number(this.virtual_scroll.start_index)+U.number(this.virtual_scroll.size),this.els["main-body-content"].css({"padding-top":this.virtual_scroll.start_index*cfg.item_height}),this.els["main-body-content-tbody"].html(this._get_list("main-body")),this.els["main-body-content"].find('[data-touch-grid-item-row="'+this.focused_index+'"]').class_name("add","focus"),this.els["main-body-content-tbody"].off("click"),this.els["main-body-content-tbody"].on("click",function(e){this._onclick(e||window.event)}.bind(this))},this._onclick=function(e,target,index,that){target=axd.parent(e.target,function(target){return axd.attr(target,"data-touch-grid-item-row")?!0:void 0}),target&&(index=axd.attr(target,"data-touch-grid-item-row"),this.focus(index),that={list:this.list,item:this.list[index],index:index,target:this.target.elements[0],item_target:this.els["main-body-content"].find('[data-touch-grid-item-row="'+index+'"]')},cfg.body.onclick&&cfg.body.onclick.call(that))},this._oncontrol=function(e,target,index,that){target=axd.parent(e.target,function(target){return axd.attr(target,"data-touch-grid-control")?!0:void 0}),target&&(index=axd.attr(target,"data-touch-grid-control"),that={control:index,target:this.target.elements[0],item_target:target},"first"==index?this.focus(0):"prev"==index?this.focus(-1,"by"):"next"==index?this.focus(1,"by"):"last"==index&&this.focus("last"),cfg.control.onclick&&cfg.control.onclick.call(that))},this.set_list=function(list){return this.list=list,this.focused_index=0,this._content_scroll(0),this},this.clear=function(){return this.list=[],this.focused_index=-1,this._content_scroll(0),this},this.append=function(item){return this.list.push(item),this.focused_index=0,this._content_scroll(),this.focus("last"),this},this.update=function(index,json){if("undefined"!=typeof index&&this.list[index]){for(var k in json)this.list[index][k]=json[k];this._content_scroll(),this.focus(index)}return this},this.remove=function(index){if("undefined"==typeof index&&(index=this.list.length-1),!this.list[index])return this;this.list.splice(index,1),index==this.focused_index&&(0==index?this.focused_index=0:1==this.list.length?this.focused_index=0:this.focused_index-=1);var focused_item_top,body_content_top,body_height,view_position_top;return focused_item_top=this.focused_index*cfg.item_height,body_content_top=this.els["main-body-content"].position().top,body_height=this.els["main-body"].height(),view_position_top=focused_item_top+body_content_top,view_position_top+cfg.item_height>body_height?this._content_scroll(-(body_height-(focused_item_top+cfg.item_height))):0>view_position_top?this._content_scroll(focused_item_top):this._content_scroll(),this},this.focus=function(index,by){if(this.focused_index>-1&&this.els["main-body-content"].find('[data-touch-grid-item-row="'+this.focused_index+'"]').class_name("remove","focus"),"last"==index)index=this.list.length-1;else if("undefined"!=typeof by){if(-1==this.focused_index)return;index=this.focused_index+index}index=U.number(index),0>index&&(index=0),index>=this.list.length&&(index=this.list.length-1),this.focused_index=index;var focused_item_top,body_content_top,body_height,view_position_top;return focused_item_top=index*cfg.item_height,body_content_top=this.els["main-body-content"].position().top,body_height=this.els["main-body"].height(),view_position_top=focused_item_top+body_content_top,view_position_top+cfg.item_height>body_height?this._content_scroll(-(body_height-(focused_item_top+cfg.item_height))):0>view_position_top?this._content_scroll(focused_item_top):this.els["main-body-content"].find('[data-touch-grid-item-row="'+index+'"]').class_name("add","focus"),this},this.get=function(cmd){return"undefined"==typeof cmd||"all"==cmd?this.list:"selected"==cmd?-1==this.focused_index?{}:{index:this.focused_index,item:this.list[this.focused_index]}:void 0}};U.is_function(ax_super)&&(ax_class.prototype=new ax_super),root.touch_grid=ax_class,"function"==typeof define&&define.amd&&define("_ax5_ui_touch_grid",[],function(){return ax_class})}(ax5.ui,ax5.ui.root);